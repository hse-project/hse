name: CodeQL

on:
  push:
    branches:
      - master
      - "v[0-9]+.[0-9]+"
  pull_request:
    paths:
      - "**.c"
      - "**.cc"
      - "**.h"
      - "**.py"
      - .github/workflows/codeql.yaml
  schedule:
    - cron: 0 0 * * SUN

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  packages: read
  security-events: write

jobs:
  codeql:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/hse-project/ci-images/fedora-36:${{ github.base_ref }}

    steps:
      - name: Checkout HSE
        uses: actions/checkout@v3

      - name: Cache Meson packagecache
        uses: actions/cache@v3
        with:
          path: subprojects/packagecache
          key: meson-packagecache-fedora-36-${{ hashFiles('subprojects/*.wrap') }}

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2

      # Ideally we compile no code from subprojects other than built-in code.
      # CodeQL will analyze any code that actually gets built. Fedora doesn't
      # package all cJSON functionality we need, so build it and cross fingers!
      #
      # https://bugzilla.redhat.com/show_bug.cgi?id=2117773
      - name: Setup
        run: |
          meson builddir --fatal-meson-warnings --werror \
            -Dwrap_mode=nofallback -Dforce_fallback_for=cjson -Dbindings=none \
            -Ddocs=disabled

      - name: Build
        run: |
          ninja -C builddir

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v2
