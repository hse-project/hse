#!/usr/bin/env python3

# SPDX-License-Identifier: Apache-2.0 OR MIT
#
# SPDX-FileCopyrightText: Copyright 2022 Micron Technology, Inc.

import argparse
import pathlib
import time
from typing import TYPE_CHECKING, cast

if TYPE_CHECKING:
    from typing import Protocol

    class Arguments(Protocol):
        name: str
        input: pathlib.Path
        output: pathlib.Path


parser = argparse.ArgumentParser(
    description="Convert a file into a C-style header file similar to xxd"
)
parser.add_argument("-n", "--name", required=True, help="Variable name")
parser.add_argument("input", type=pathlib.Path, help="Input file")
parser.add_argument("output", type=pathlib.Path, help="Output file")

args = cast("Arguments", parser.parse_args())

INCLUDE_GUARD = f"{args.name.upper()}_{int(time.time())}_H"

inb = args.input.read_bytes()

with open(args.output, "w", encoding="utf-8") as outf:
    outf.write("/* Generated by includeify. DO NOT EDIT. */\n\n")
    outf.write(f"#ifndef {INCLUDE_GUARD}_H\n")
    outf.write(f"#define {INCLUDE_GUARD}_H\n\n")

    outf.write(f"const unsigned char {args.name}[] = {{\n")

    for i, b in enumerate(inb):
        if i % 8 == 0:
            outf.write("\t")
        outf.write(f"{b:#04x},")
        if (i != 0 and i % 8 == 7) or i == len(inb) - 1:
            outf.write("\n")
        else:
            outf.write(" ")

    outf.write("};\n\n")

    outf.write("#endif\n")
